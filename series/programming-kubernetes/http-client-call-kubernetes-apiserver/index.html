<!doctype html><html lang=zh dir=auto>
<head>
<link rel=stylesheet href=/css/fi.css crossorigin=anonymous><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>HTTP 客户端调用 Kubernetes APIServer | 博客 · 丁鹏</title>
<meta name=keywords content>
<meta name=description content="本篇介绍 HTTP 客户端调用 Kubernetes APIServer 的方法。 如何获取 Kubernetes api-server 地址 查看 api-server 的几种方式： # 1. 直接查看 kubeconfig 文件 $ cat ~/.kube/config apiVersion: v1 clusters: - cluster: server: https://192.168.58.2:8443 ... # 2. kubectl 查看集群信息 $ kubectl cluster-info Kubernetes control plane is running">
<meta name=author content="Pone Ding">
<link rel=canonical href=https://blog.poneding.com/series/programming-kubernetes/http-client-call-kubernetes-apiserver/>
<meta name=baidu-site-verification content="codeva-TIM45BA2zX">
<meta name=google-site-verification content="gigju1hgWV5auIGFQ92BEHHWLdQlDKD9Vtr0i0nJTdc">
<meta name=msvalidate.01 content="A6DA701A68DFFC170A595897CB4DF119">
<link crossorigin=anonymous href=/assets/css/stylesheet.65f6d323040845323012b2b152ef69268b9604fa8bfd2586c65c94d786ed4850.css integrity="sha256-ZfbTIwQIRTIwErKxUu9pJouWBPqL/SWGxlyU14btSFA=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.poneding.com/images/blog.png>
<link rel=icon type=image/png sizes=16x16 href=https://blog.poneding.com/images/blog.png>
<link rel=icon type=image/png sizes=32x32 href=https://blog.poneding.com/images/blog.png>
<link rel=apple-touch-icon href=https://blog.poneding.com/images/blog.png>
<link rel=mask-icon href=https://blog.poneding.com/images/blog.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="HTTP 客户端调用 Kubernetes APIServer">
<meta property="og:description" content="本篇介绍 HTTP 客户端调用 Kubernetes APIServer 的方法。 如何获取 Kubernetes api-server 地址 查看 api-server 的几种方式： # 1. 直接查看 kubeconfig 文件 $ cat ~/.kube/config apiVersion: v1 clusters: - cluster: server: https://192.168.58.2:8443 ... # 2. kubectl 查看集群信息 $ kubectl cluster-info Kubernetes control plane is running">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.poneding.com/series/programming-kubernetes/http-client-call-kubernetes-apiserver/">
<meta property="og:image" content="https://fs.poneding.com/images/202305041515191.png"><meta property="article:section" content="series">
<meta property="article:published_time" content="2023-05-04T07:09:50+00:00">
<meta property="article:modified_time" content="2023-05-04T07:09:50+00:00"><meta property="og:site_name" content="博客">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://fs.poneding.com/images/202305041515191.png">
<meta name=twitter:title content="HTTP 客户端调用 Kubernetes APIServer">
<meta name=twitter:description content="本篇介绍 HTTP 客户端调用 Kubernetes APIServer 的方法。 如何获取 Kubernetes api-server 地址 查看 api-server 的几种方式： # 1. 直接查看 kubeconfig 文件 $ cat ~/.kube/config apiVersion: v1 clusters: - cluster: server: https://192.168.58.2:8443 ... # 2. kubectl 查看集群信息 $ kubectl cluster-info Kubernetes control plane is running">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"系列","item":"https://blog.poneding.com/series/"},{"@type":"ListItem","position":2,"name":"Kubernetes 编程","item":"https://blog.poneding.com/series/programming-kubernetes/"},{"@type":"ListItem","position":3,"name":"HTTP 客户端调用 Kubernetes APIServer","item":"https://blog.poneding.com/series/programming-kubernetes/http-client-call-kubernetes-apiserver/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HTTP 客户端调用 Kubernetes APIServer","name":"HTTP 客户端调用 Kubernetes APIServer","description":"本篇介绍 HTTP 客户端调用 Kubernetes APIServer 的方法。 如何获取 Kubernetes api-server 地址 查看 api-server 的几种方式： # 1. 直接查看 kubeconfig 文件 $ cat ~/.kube/config apiVersion: v1 clusters: - cluster: server: https://192.168.58.2:8443 ... # 2. kubectl 查看集群信息 $ kubectl cluster-info Kubernetes control plane is running","keywords":[],"articleBody":"本篇介绍 HTTP 客户端调用 Kubernetes APIServer 的方法。\n如何获取 Kubernetes api-server 地址 查看 api-server 的几种方式：\n# 1. 直接查看 kubeconfig 文件 $ cat ~/.kube/config apiVersion: v1 clusters: - cluster: server: https://192.168.58.2:8443 ... # 2. kubectl 查看集群信息 $ kubectl cluster-info Kubernetes control plane is running at https://192.168.58.2:8443 ... # 3. kubectl 查看集群配置 $ kubectl config view clusters: - cluster: ... server: https://192.168.58.2:8443 ... 配置环境变量\nKUBE_API=$(kubectl config view -o jsonpath='{.clusters[0].cluster.server}') echo $KUBE_API api-server 如何给客户端授权 使用证书授权 直接调用：\n$ curl $KUBE_API/version curl: (60) SSL certificate problem: unable to get local issuer certificate More details here: https://curl.haxx.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. # 忽略证书验证 $ curl $KUBE_API/version --insecure { \"kind\": \"Status\", \"apiVersion\": \"v1\", \"metadata\": { }, \"status\": \"Failure\", \"message\": \"Unauthorized\", \"reason\": \"Unauthorized\", \"code\": 401 } 结果是我们无法顺利调用接口。\n获取证书：\n# 服务端证书 $ kubectl config view --raw \\  -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' \\  | base64 --decode  ./server-ca.crt # 服务端证书 $ kubectl config view --raw \\  -o jsonpath='{.users[0].user.client-certificate-data}' \\  | base64 --decode  ./client-ca.crt # 服务端证书密钥 $ kubectl config view --raw \\  -o jsonpath='{.users[0].user.client-key-data}' \\  | base64 --decode  ./client-ca.key 我们这次尝试使用证书调用 API：\n$ curl $KUBE_API/version --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key { \"major\": \"1\", \"minor\": \"22\", \"gitVersion\": \"v1.22.6+k3s1\", \"gitCommit\": \"3228d9cb9a4727d48f60de4f1ab472f7c50df904\", \"gitTreeState\": \"clean\", \"buildDate\": \"2022-01-25T01:27:44Z\", \"goVersion\": \"go1.16.10\", \"compiler\": \"gc\", \"platform\": \"linux/amd64\" } 此时，可以正常调用 API 了，我们继续调用其他接口：\n$ curl $KUBE_API/apis/apps/v1/deployments --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key { \"kind\": \"DeploymentList\", \"apiVersion\": \"apps/v1\", \"metadata\": { \"resourceVersion\": \"654514\" }, \"items\": [...] } 也 OK 了。\n使用 token 授权 token 指的是 ServiceAccount 的 Token，每个命名空间内都会存在一个默认的 sa：default。\n我们尝试来生成 sa token，我们首先生成一个 default 命名空间下 default sa 的 token：\n# 获取 sa 采用的 secret $ kubectl get sa default -o jsonpath='{.secrets[0].name}' # 获取 token DEFAULT_DEFAULT_TOKEN=$(kubectl get secrets \\  $(kubectl get sa default -o jsonpath='{.secrets[0].name}') \\  -o jsonpath='{.data.token}' | base64 --decode) $ echo $DEFAULT_DEFAULT_TOKEN eyJhbGciOiJSUzI1NiIsImtpZCI6IjFJdzhRZlV3TkpRRm5aSzU4b2hWTWI3YmdPUTlyLTBWSU9OQmNlN3cwdGsifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tcW50bGsiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjE0OGJmM2U0LTkzY2EtNGJiMS04MDczLWMzZmIzM2NiYmJmNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.ivtk9eRH-35wIaPk4CtPSBoBkuiMxQyta17qMxNjhgedyV5i1QGYty36k0ufbOpBMXr2DsdRy8yQTx2qnH-AcduyxaoCxX-SQ4yGUsKSHCTipktcWqFi-CFzNo6EMCZiX8zAmeXjYOMmF8kh2T6wkHmjERDYsqWPaftasTUrKEYpcawFCMnv0QTpDe-okr6vQx6t7pJ5fx_PCw-GEEZUKQZn1tHIStd77eZd546--rrS6nPczKc3GnVFsDTcPM5HI7T_hXnId1TEnOYM8H5ornJ6uDP2oN_niwV41qOXMM52Bep0cvnikG-kUklLpmZxkwAtQCHDDh36A5JX_oaK5w 💡 如果你的 kubectl 版本大于 1.24，那么你可以直接使用以下命令获取 token：\n$ DEFAULT_DEFAULT_TOKEN=$(kubectl create token default -n default) $ echo $DEFAULT_DEFAULT_TOKEN eyJhbGciOiJSUzI1NiIsImtpZCI6IjFJdzhRZlV3TkpRRm5aSzU4b2hWTWI3YmdPUTlyLTBWSU9OQmNlN3cwdGsifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiLCJrM3MiXSwiZXhwIjoxNjc2NDUwODg2LCJpYXQiOjE2NzY0NDcyODYsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwic2VydmljZWFjY291bnQiOnsibmFtZSI6ImRlZmF1bHQiLCJ1aWQiOiIxNDhiZjNlNC05M2NhLTRiYjEtODA3My1jM2ZiMzNjYmJiZjYifX0sIm5iZiI6MTY3NjQ0NzI4Niwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6ZGVmYXVsdCJ9.FC6SZ3fKhKML76AYnfaq4Y74mlRMBUxgfsEocrczzoN_NvDbqzZ_0sCAvA_ZdcVXv74hXTTeO1_DLoXZE_aLmGIxH1ImfbCDbxZH1xvNbE-7oozKmWBjYM7VRnNVvNC8EiRmcSEMttnQxgnBqUDZCyU8VA_pujld_RsB4SiD8tpXN5PaSaEx6vz6AWYWtW8wqwcAlIWTGk4hae090a0sLplyB4xx-7SiYjmkM9tVXFz5WWdUYSfyQeM-EfDpH4fNsvefWtW_KeJ5Wg28RuhiLbUv9_UV1RGt11Wh7lf0nNmxobqB8j-PEnphiECMKDv29x5KtQDU1wSgbSMI-_eTlQ 使用 token 调用 API：\n$ curl $KUBE_API/apis/apps/v1/namespaces/default/deployments --cacert ./server-ca.crt \\  -H \"Authorization: Bearer $DEFAULT_DEFAULT_TOKEN\" { \"kind\": \"Status\", \"apiVersion\": \"v1\", \"metadata\": { } \"status\": \"Failure\", \"message\": \"deployments.apps is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" at the cluster scope\", \"reason\": \"Forbidden\", \"details\": { \"group\": \"apps\", \"kind\": \"deployments\" }, \"code\": 403 } 可以看到用户 system:serviceaccount:default:default 并没有权限获取自身命名空间内的 Kubernetes 对象列表。\n接下来让我们尝试给这个 sa 绑定一个 cluster-admin 的 ClusterRole，然后我们再次生成 token，并调用接口：\n$ kubectl create clusterrolebinding default-sa-with-cluster-admin-role \\  --clusterrole cluster-admin --serviceaccount default:default $ DEFAULT_DEFAULT_TOKEN=$(kubectl create token default -n default) $ curl $KUBE_API/apis/apps/v1/namespaces/default/deployments --cacert ./server-ca.crt \\  -H \"Authorization: Bearer $DEFAULT_DEFAULT_TOKEN\" { \"kind\": \"DeploymentList\", \"apiVersion\": \"apps/v1\", \"metadata\": { \"resourceVersion\": \"2824281\" }, \"items\": [] } 这完美生效，因为 defualt sa 有了一个超级大的 admin 角色。（另外，你可以单独创建一个特定资源权限的 role，在绑定到一个 sa，来满足最小权限原则）\n在 Pod 内访问 api-server 在 pod 内部，默认会生成 Kubernetes 服务地址相关的环境变量，并且会在特殊目录下保存证书以及 token，当然这个token 是根据 pod 所使用的 sa 生成的。\n证书文件地址：/var/run/secrets/kubernetes.io/serviceaccount/ca.crt\ntoken 文件地址：/var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n$ kubectl run -it --image curlimages/curl --restart=Never mypod -- sh $ env | grep KUBERNETES KUBERNETES_SERVICE_PORT=443 KUBERNETES_PORT=tcp://10.43.0.1:443 KUBERNETES_PORT_443_TCP_ADDR=10.43.0.1 KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT_443_TCP=tcp://10.43.0.1:443 KUBERNETES_SERVICE_HOST=10.43.0.1 $ TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) $ curl https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}/apis/apps/v1 \\  --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \\  --header \"Authorization: Bearer $TOKEN\" 使用 curl 执行基本的 CRUD 操作 创建资源：\n$ curl $KUBE_API/apis/apps/v1/namespaces/default/deployments \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key \\  -X POST \\  -H 'Content-Type: application/yaml' \\  -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"365d\"] ' $ kubectl get deploy NAME READY UP-TO-DATE AVAILABLE AGE sleep 1/1 1 1 8s 获取资源：\n$ curl $KUBE_API/apis/apps/v1/namespaces/default/deployments \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key # 给定特定的资源名 $ curl $KUBE_API/apis/apps/v1/namespaces/default/deployments/sleep \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key # watch $ curl $KUBE_API'/apis/apps/v1/namespaces/default/deployments?watch=true' \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key 更新资源：\ncurl $KUBE_API/apis/apps/v1/namespaces/default/deployments/sleep \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key \\  -X PUT \\  -H 'Content-Type: application/yaml' \\  -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"730d\"] # ' # patch 更新 curl $KUBE_API/apis/apps/v1/namespaces/default/deployments/sleep \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key \\  -X PATCH \\  -H 'Content-Type: application/merge-patch+json' \\  -d '{ \"spec\": { \"template\": { \"spec\": { \"containers\": [ { \"name\": \"sleep\", \"image\": \"curlimages/curl\", \"command\": [\"/bin/sleep\", \"1d\"] } ] } } } }' 删除资源：\n$ curl $KUBE_API/apis/apps/v1/namespaces/default/deployments \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key \\  -X DELETE # 删除单个资源 $ curl $KUBE_API/apis/apps/v1/namespaces/default/deployments/sleep \\  --cacert ./server-ca.crt \\  --cert ./client-ca.crt \\  --key ./client-ca.key \\  -X DELETE 如何使用 kubectl 调用 API 使用 kubectl 代理 Kubernetes api-server $ kubectl proxy --port 8080 # 启动了代理服务后，调用 Kubernetes api-server 变得更简单 $ curl localhost:8080/apis/apps/v1/deployments { \"kind\": \"DeploymentList\", \"apiVersion\": \"apps/v1\", \"metadata\": { \"resourceVersion\": \"660883\" }, \"items\": [...] } kubectl 使用原始模式调用 API # 获取 $ kubectl get --raw /api/v1/namespaces/default/pods # 创建 $ kubectl create --raw /api/v1/namespaces/default/pods -f file.yaml # 更新 $ kubectl replace --raw /api/v1/namespaces/default/pods/mypod -f file.json # 删除 $ kubectl delete --raw /api/v1/namespaces/default/pods 如何查看 kubectl 命令（如 apply）发送的 API 请求 $ kubectl create deployment nginx --image nginx -v 6 I0215 17:07:35.188480 43870 loader.go:372] Config loaded from file: /Users/dp/.kube/config I0215 17:07:35.362580 43870 round_trippers.go:553] POST https://192.168.58.2:8443/apis/apps/v1/namespaces/default/deployments?fieldManager=kubectl-create\u0026fieldValidation=Strict 201 Created in 167 milliseconds deployment.apps/nginx created 参考  How To Call Kubernetes API using Simple HTTP Client 使用 Kubernetes API 访问集群 | Kubernetes 从 Pod 中访问 Kubernetes API | Kuberentes  ","wordCount":"1493","inLanguage":"zh","image":"https://fs.poneding.com/images/202305041515191.png","datePublished":"2023-05-04T07:09:50.614Z","dateModified":"2023-05-04T07:09:50.614Z","author":[{"@type":"Person","name":"Pone Ding"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.poneding.com/series/programming-kubernetes/http-client-call-kubernetes-apiserver/"},"publisher":{"@type":"Organization","name":"博客 · 丁鹏","logo":{"@type":"ImageObject","url":"https://blog.poneding.com/images/blog.png"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blog.poneding.com/ accesskey=h title="博客 (Alt + H)">
<img src=https://blog.poneding.com/images/blog.png alt aria-label=logo height=25>博客</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=https://blog.poneding.com/posts/ title=文章>
<span>
<i class="fi fi-book"></i>&nbsp;文章</span>
</a>
</li>
<li>
<a href=https://blog.poneding.com/series/ title=系列>
<span class=active>
<i class="fi fi-series"></i>&nbsp;系列</span>
</a>
</li>
<li>
<a href=https://blog.poneding.com/tags/ title=标签>
<span>
<i class="fi fi-tags"></i>&nbsp;标签</span>
</a>
</li>
<li>
<a href=https://blog.poneding.com/archives/ title=归档>
<span>
<i class="fi fi-folder"></i>&nbsp;归档</span>
</a>
</li>
<li>
<a href=/search title="Alt + /" accesskey=/>
<span>
<i class="fi fi-search"></i>
</span>
</a>
</li>
<li>
<span>|</span>
</li>
<li>
<span>
<a href=https://github.com/poneding target=_blank rel="noopener noreferrer me">
<i class="fi fi-github"></i>
</a>
<span>·</span>
<a href=mailto:poneding@gmail.com target=_blank rel="noopener noreferrer me">
<i class="fi fi-mail"></i>
</a>
</span>
</li>
</ul>
</nav>
</header><main class=main>
<article class=post-single>
<div class=post-left-article>
<header class=post-header>
<div class=breadcrumbs><p>
<span><a href=/><i class="fi fi-home"></i>&nbsp;主页</a></span><span><i class="fi fi-angle-right"></i><a href=https://blog.poneding.com/series/>系列</a></span><span><i class="fi fi-angle-right"></i><a href=https://blog.poneding.com/series/programming-kubernetes/>Kubernetes 编程</a></span><i class="fi fi-angle-right"></i><span>HTTP 客户端调用 Kubernetes APIServer</span>
</p>
</div>
<h1 id=post-title class=post-title>
HTTP 客户端调用 Kubernetes APIServer
</h1>
<div class=post-meta><span class=meta-item>
<span>
<i class="fi fi-clock"></i>2023-05-04
</span>
</span><span class=meta-item>
<span>
&nbsp;·&nbsp;<i class="fi fi-word"></i>1493 字</span>
</span><span class=meta-item>
&nbsp;·&nbsp;<i class="fi fi-eye"></i>&nbsp;<span id=busuanzi_value_page_pv></span>
</span>&nbsp;|&nbsp;<a href=https://github.com/poneding/blog/edit/master/content/series/programming-kubernetes/http-%e5%ae%a2%e6%88%b7%e7%ab%af%e8%b0%83%e7%94%a8-kubernetes-apiserver.md rel="noopener noreferrer" target=_blank>
<i class="fi fi-edit"></i>&nbsp;编辑</a>
</div>
</header>
<figure class=post-single-cover><input type=checkbox id=zoomCheck-cover3 hidden>
<label for=zoomCheck-cover3><img class=zoomCheck loading=lazy src=https://fs.poneding.com/images/202305041515191.png alt></label>
</figure>
<div class=post-content><p>本篇介绍 HTTP 客户端调用 Kubernetes APIServer 的方法。</p>
<h2 id=如何获取-kubernetes-api-server-地址>如何获取 Kubernetes api-server 地址<a hidden class=anchor aria-hidden=true href=#如何获取-kubernetes-api-server-地址>#</a></h2>
<p>查看 api-server 的几种方式：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 1. 直接查看 kubeconfig 文件</span>
$ cat ~/.kube/config 
apiVersion: v1
clusters:
- cluster:
    server: https://192.168.58.2:8443
...

<span class=c1># 2. kubectl 查看集群信息</span>
$ kubectl cluster-info
Kubernetes control plane is running at https://192.168.58.2:8443
...

<span class=c1># 3. kubectl 查看集群配置</span>
$ kubectl config view
clusters:
- cluster:
    ...
    server: https://192.168.58.2:8443
...
</code></pre></div><p>配置环境变量</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nv>KUBE_API</span><span class=o>=</span><span class=k>$(</span>kubectl config view -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.clusters[0].cluster.server}&#39;</span><span class=k>)</span>

<span class=nb>echo</span> <span class=nv>$KUBE_API</span>
</code></pre></div><h2 id=api-server-如何给客户端授权>api-server 如何给客户端授权<a hidden class=anchor aria-hidden=true href=#api-server-如何给客户端授权>#</a></h2>
<h3 id=使用证书授权>使用证书授权<a hidden class=anchor aria-hidden=true href=#使用证书授权>#</a></h3>
<p>直接调用：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl <span class=nv>$KUBE_API</span>/version
curl: <span class=o>(</span>60<span class=o>)</span> SSL certificate problem: unable to get <span class=nb>local</span> issuer certificate
More details here: https://curl.haxx.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.

<span class=c1># 忽略证书验证</span>
$ curl <span class=nv>$KUBE_API</span>/version --insecure
<span class=o>{</span>
  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;Status&#34;</span>,
  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{</span>

  <span class=o>}</span>,
  <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;Failure&#34;</span>,
  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Unauthorized&#34;</span>,
  <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;Unauthorized&#34;</span>,
  <span class=s2>&#34;code&#34;</span>: <span class=m>401</span>
<span class=o>}</span>
</code></pre></div><p>结果是我们无法顺利调用接口。</p>
<p>获取证书：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 服务端证书</span>
$ kubectl config view --raw <span class=se>\
</span><span class=se></span>  -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.clusters[0].cluster.certificate-authority-data}&#39;</span> <span class=se>\
</span><span class=se></span>  <span class=p>|</span> base64 --decode &gt; ./server-ca.crt

<span class=c1># 服务端证书</span>
$ kubectl config view --raw <span class=se>\
</span><span class=se></span>  -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.users[0].user.client-certificate-data}&#39;</span> <span class=se>\
</span><span class=se></span>  <span class=p>|</span> base64 --decode &gt; ./client-ca.crt

<span class=c1># 服务端证书密钥</span>
$ kubectl config view --raw <span class=se>\
</span><span class=se></span>  -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.users[0].user.client-key-data}&#39;</span> <span class=se>\
</span><span class=se></span>  <span class=p>|</span> base64 --decode &gt; ./client-ca.key
</code></pre></div><p>我们这次尝试使用证书调用 API：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl <span class=nv>$KUBE_API</span>/version --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key
<span class=o>{</span>
  <span class=s2>&#34;major&#34;</span>: <span class=s2>&#34;1&#34;</span>,
  <span class=s2>&#34;minor&#34;</span>: <span class=s2>&#34;22&#34;</span>,
  <span class=s2>&#34;gitVersion&#34;</span>: <span class=s2>&#34;v1.22.6+k3s1&#34;</span>,
  <span class=s2>&#34;gitCommit&#34;</span>: <span class=s2>&#34;3228d9cb9a4727d48f60de4f1ab472f7c50df904&#34;</span>,
  <span class=s2>&#34;gitTreeState&#34;</span>: <span class=s2>&#34;clean&#34;</span>,
  <span class=s2>&#34;buildDate&#34;</span>: <span class=s2>&#34;2022-01-25T01:27:44Z&#34;</span>,
  <span class=s2>&#34;goVersion&#34;</span>: <span class=s2>&#34;go1.16.10&#34;</span>,
  <span class=s2>&#34;compiler&#34;</span>: <span class=s2>&#34;gc&#34;</span>,
  <span class=s2>&#34;platform&#34;</span>: <span class=s2>&#34;linux/amd64&#34;</span>
<span class=o>}</span>
</code></pre></div><p>此时，可以正常调用 API 了，我们继续调用其他接口：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/deployments --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key
<span class=o>{</span>
  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;DeploymentList&#34;</span>,
  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;apps/v1&#34;</span>,
  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;resourceVersion&#34;</span>: <span class=s2>&#34;654514&#34;</span>
  <span class=o>}</span>,
  <span class=s2>&#34;items&#34;</span>: <span class=o>[</span>...<span class=o>]</span>
<span class=o>}</span>
</code></pre></div><p>也 OK 了。</p>
<h3 id=使用-token-授权>使用 token 授权<a hidden class=anchor aria-hidden=true href=#使用-token-授权>#</a></h3>
<p>token 指的是 ServiceAccount 的 Token，每个命名空间内都会存在一个默认的 sa：default。</p>
<p>我们尝试来生成 sa token，我们首先生成一个 default 命名空间下 default sa 的 token：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 获取 sa 采用的 secret</span>
$ kubectl get sa default -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.secrets[0].name}&#39;</span>

<span class=c1># 获取 token</span>
<span class=nv>DEFAULT_DEFAULT_TOKEN</span><span class=o>=</span><span class=k>$(</span>kubectl get secrets <span class=se>\
</span><span class=se></span>  <span class=k>$(</span>kubectl get sa default -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.secrets[0].name}&#39;</span><span class=k>)</span> <span class=se>\
</span><span class=se></span>  -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.token}&#39;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

$ <span class=nb>echo</span> <span class=nv>$DEFAULT_DEFAULT_TOKEN</span>
eyJhbGciOiJSUzI1NiIsImtpZCI6IjFJdzhRZlV3TkpRRm5aSzU4b2hWTWI3YmdPUTlyLTBWSU9OQmNlN3cwdGsifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tcW50bGsiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjE0OGJmM2U0LTkzY2EtNGJiMS04MDczLWMzZmIzM2NiYmJmNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.ivtk9eRH-35wIaPk4CtPSBoBkuiMxQyta17qMxNjhgedyV5i1QGYty36k0ufbOpBMXr2DsdRy8yQTx2qnH-AcduyxaoCxX-SQ4yGUsKSHCTipktcWqFi-CFzNo6EMCZiX8zAmeXjYOMmF8kh2T6wkHmjERDYsqWPaftasTUrKEYpcawFCMnv0QTpDe-okr6vQx6t7pJ5fx_PCw-GEEZUKQZn1tHIStd77eZd546--rrS6nPczKc3GnVFsDTcPM5HI7T_hXnId1TEnOYM8H5ornJ6uDP2oN_niwV41qOXMM52Bep0cvnikG-kUklLpmZxkwAtQCHDDh36A5JX_oaK5w
</code></pre></div><p>💡 如果你的 kubectl 版本大于 1.24，那么你可以直接使用以下命令获取 token：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nv>DEFAULT_DEFAULT_TOKEN</span><span class=o>=</span><span class=k>$(</span>kubectl create token default -n default<span class=k>)</span>

$ <span class=nb>echo</span> <span class=nv>$DEFAULT_DEFAULT_TOKEN</span>
eyJhbGciOiJSUzI1NiIsImtpZCI6IjFJdzhRZlV3TkpRRm5aSzU4b2hWTWI3YmdPUTlyLTBWSU9OQmNlN3cwdGsifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiLCJrM3MiXSwiZXhwIjoxNjc2NDUwODg2LCJpYXQiOjE2NzY0NDcyODYsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwic2VydmljZWFjY291bnQiOnsibmFtZSI6ImRlZmF1bHQiLCJ1aWQiOiIxNDhiZjNlNC05M2NhLTRiYjEtODA3My1jM2ZiMzNjYmJiZjYifX0sIm5iZiI6MTY3NjQ0NzI4Niwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6ZGVmYXVsdCJ9.FC6SZ3fKhKML76AYnfaq4Y74mlRMBUxgfsEocrczzoN_NvDbqzZ_0sCAvA_ZdcVXv74hXTTeO1_DLoXZE_aLmGIxH1ImfbCDbxZH1xvNbE-7oozKmWBjYM7VRnNVvNC8EiRmcSEMttnQxgnBqUDZCyU8VA_pujld_RsB4SiD8tpXN5PaSaEx6vz6AWYWtW8wqwcAlIWTGk4hae090a0sLplyB4xx-7SiYjmkM9tVXFz5WWdUYSfyQeM-EfDpH4fNsvefWtW_KeJ5Wg28RuhiLbUv9_UV1RGt11Wh7lf0nNmxobqB8j-PEnphiECMKDv29x5KtQDU1wSgbSMI-_eTlQ
</code></pre></div><p>使用 token 调用 API：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$DEFAULT_DEFAULT_TOKEN</span><span class=s2>&#34;</span>
<span class=o>{</span>
  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;Status&#34;</span>,
  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{</span>

  <span class=o>}</span>
  <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;Failure&#34;</span>,
  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;deployments.apps is forbidden: User \&#34;system:serviceaccount:default:default\&#34; cannot list resource \&#34;deployments\&#34; in API group \&#34;apps\&#34; at the cluster scope&#34;</span>,
  <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;Forbidden&#34;</span>,
  <span class=s2>&#34;details&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;group&#34;</span>: <span class=s2>&#34;apps&#34;</span>,
    <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;deployments&#34;</span>
  <span class=o>}</span>,
  <span class=s2>&#34;code&#34;</span>: <span class=m>403</span>
<span class=o>}</span>
</code></pre></div><p>可以看到用户 <code>system:serviceaccount:default:default</code> 并没有权限获取自身命名空间内的 Kubernetes 对象列表。</p>
<p>接下来让我们尝试给这个 sa 绑定一个 <code>cluster-admin</code> 的 ClusterRole，然后我们再次生成 token，并调用接口：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl create clusterrolebinding default-sa-with-cluster-admin-role <span class=se>\
</span><span class=se></span>  --clusterrole cluster-admin --serviceaccount default:default

$ <span class=nv>DEFAULT_DEFAULT_TOKEN</span><span class=o>=</span><span class=k>$(</span>kubectl create token default -n default<span class=k>)</span>

$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$DEFAULT_DEFAULT_TOKEN</span><span class=s2>&#34;</span>
<span class=o>{</span>
  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;DeploymentList&#34;</span>,
  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;apps/v1&#34;</span>,
  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;resourceVersion&#34;</span>: <span class=s2>&#34;2824281&#34;</span>
  <span class=o>}</span>,
  <span class=s2>&#34;items&#34;</span>: <span class=o>[]</span>
<span class=o>}</span>
</code></pre></div><p>这完美生效，因为 defualt sa 有了一个超级大的 admin 角色。（另外，你可以单独创建一个特定资源权限的 role，在绑定到一个 sa，来满足最小权限原则）</p>
<h2 id=在-pod-内访问-api-server>在 Pod 内访问 api-server<a hidden class=anchor aria-hidden=true href=#在-pod-内访问-api-server>#</a></h2>
<p>在 pod 内部，默认会生成 Kubernetes 服务地址相关的环境变量，并且会在特殊目录下保存证书以及 token，当然这个token 是根据 pod 所使用的 sa 生成的。</p>
<p>证书文件地址：/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</p>
<p>token 文件地址：/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl run -it --image curlimages/curl --restart<span class=o>=</span>Never mypod -- sh
$ env <span class=p>|</span> grep KUBERNETES
<span class=nv>KUBERNETES_SERVICE_PORT</span><span class=o>=</span><span class=m>443</span>
<span class=nv>KUBERNETES_PORT</span><span class=o>=</span>tcp://10.43.0.1:443
<span class=nv>KUBERNETES_PORT_443_TCP_ADDR</span><span class=o>=</span>10.43.0.1
<span class=nv>KUBERNETES_PORT_443_TCP_PORT</span><span class=o>=</span><span class=m>443</span>
<span class=nv>KUBERNETES_PORT_443_TCP_PROTO</span><span class=o>=</span>tcp
<span class=nv>KUBERNETES_SERVICE_PORT_HTTPS</span><span class=o>=</span><span class=m>443</span>
<span class=nv>KUBERNETES_PORT_443_TCP</span><span class=o>=</span>tcp://10.43.0.1:443
<span class=nv>KUBERNETES_SERVICE_HOST</span><span class=o>=</span>10.43.0.1

$ <span class=nv>TOKEN</span><span class=o>=</span><span class=k>$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span class=k>)</span>
$ curl https://<span class=si>${</span><span class=nv>KUBERNETES_SERVICE_HOST</span><span class=si>}</span>:<span class=si>${</span><span class=nv>KUBERNETES_SERVICE_PORT</span><span class=si>}</span>/apis/apps/v1 <span class=se>\
</span><span class=se></span>  --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt <span class=se>\
</span><span class=se></span>  --header <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$TOKEN</span><span class=s2>&#34;</span>
</code></pre></div><h2 id=使用-curl-执行基本的-crud-操作>使用 curl 执行基本的 CRUD 操作<a hidden class=anchor aria-hidden=true href=#使用-curl-执行基本的-crud-操作>#</a></h2>
<p>创建资源：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments <span class=se>\
</span><span class=se></span>  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key <span class=se>\
</span><span class=se></span>  -X POST <span class=se>\
</span><span class=se></span>  -H <span class=s1>&#39;Content-Type: application/yaml&#39;</span> <span class=se>\
</span><span class=se></span>  -d <span class=s1>&#39;---
</span><span class=s1>apiVersion: apps/v1
</span><span class=s1>kind: Deployment
</span><span class=s1>metadata:
</span><span class=s1>  name: sleep
</span><span class=s1>spec:
</span><span class=s1>  replicas: 1
</span><span class=s1>  selector:
</span><span class=s1>    matchLabels:
</span><span class=s1>      app: sleep
</span><span class=s1>  template:
</span><span class=s1>    metadata:
</span><span class=s1>      labels:
</span><span class=s1>        app: sleep
</span><span class=s1>    spec:
</span><span class=s1>      containers:
</span><span class=s1>      - name: sleep
</span><span class=s1>        image: curlimages/curl
</span><span class=s1>        command: [&#34;/bin/sleep&#34;, &#34;365d&#34;]
</span><span class=s1>&#39;</span>

$ kubectl get deploy
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
sleep   1/1     <span class=m>1</span>            <span class=m>1</span>           8s
</code></pre></div><p>获取资源：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments <span class=se>\
</span><span class=se></span>  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key

<span class=c1># 给定特定的资源名</span>
$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments/sleep <span class=se>\
</span><span class=se></span>  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key

<span class=c1># watch</span>
$ curl <span class=nv>$KUBE_API</span><span class=s1>&#39;/apis/apps/v1/namespaces/default/deployments?watch=true&#39;</span> <span class=se>\ </span>             
  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key
</code></pre></div><p>更新资源：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments/sleep <span class=se>\
</span><span class=se></span>  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key <span class=se>\
</span><span class=se></span>  -X PUT <span class=se>\
</span><span class=se></span>  -H <span class=s1>&#39;Content-Type: application/yaml&#39;</span> <span class=se>\
</span><span class=se></span>  -d <span class=s1>&#39;---
</span><span class=s1>apiVersion: apps/v1
</span><span class=s1>kind: Deployment
</span><span class=s1>metadata:
</span><span class=s1>  name: sleep
</span><span class=s1>spec:
</span><span class=s1>  replicas: 1
</span><span class=s1>  selector:
</span><span class=s1>    matchLabels:
</span><span class=s1>      app: sleep
</span><span class=s1>  template:
</span><span class=s1>    metadata:
</span><span class=s1>      labels:
</span><span class=s1>        app: sleep
</span><span class=s1>    spec:
</span><span class=s1>      containers:
</span><span class=s1>      - name: sleep
</span><span class=s1>        image: curlimages/curl
</span><span class=s1>        command: [&#34;/bin/sleep&#34;, &#34;730d&#34;]  # &lt;-- Making it sleep twice longer
</span><span class=s1>&#39;</span>

<span class=c1># patch 更新</span>
curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments/sleep <span class=se>\
</span><span class=se></span>  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key <span class=se>\
</span><span class=se></span>  -X PATCH <span class=se>\
</span><span class=se></span>  -H <span class=s1>&#39;Content-Type: application/merge-patch+json&#39;</span> <span class=se>\
</span><span class=se></span>  -d <span class=s1>&#39;{
</span><span class=s1>  &#34;spec&#34;: {
</span><span class=s1>    &#34;template&#34;: {
</span><span class=s1>      &#34;spec&#34;: {
</span><span class=s1>        &#34;containers&#34;: [
</span><span class=s1>          {
</span><span class=s1>            &#34;name&#34;: &#34;sleep&#34;,
</span><span class=s1>            &#34;image&#34;: &#34;curlimages/curl&#34;,
</span><span class=s1>            &#34;command&#34;: [&#34;/bin/sleep&#34;, &#34;1d&#34;]
</span><span class=s1>          }
</span><span class=s1>        ]
</span><span class=s1>      }
</span><span class=s1>    }
</span><span class=s1>  }
</span><span class=s1>}&#39;</span>
</code></pre></div><p>删除资源：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments <span class=se>\
</span><span class=se></span>  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key <span class=se>\
</span><span class=se></span>  -X DELETE

<span class=c1># 删除单个资源</span>
$ curl <span class=nv>$KUBE_API</span>/apis/apps/v1/namespaces/default/deployments/sleep <span class=se>\
</span><span class=se></span>  --cacert ./server-ca.crt <span class=se>\
</span><span class=se></span>  --cert ./client-ca.crt <span class=se>\
</span><span class=se></span>  --key ./client-ca.key <span class=se>\
</span><span class=se></span>  -X DELETE
</code></pre></div><h2 id=如何使用-kubectl-调用-api>如何使用 kubectl 调用 API<a hidden class=anchor aria-hidden=true href=#如何使用-kubectl-调用-api>#</a></h2>
<h3 id=使用-kubectl-代理-kubernetes-api-server>使用 kubectl 代理 Kubernetes api-server<a hidden class=anchor aria-hidden=true href=#使用-kubectl-代理-kubernetes-api-server>#</a></h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl proxy --port <span class=m>8080</span>

<span class=c1># 启动了代理服务后，调用 Kubernetes api-server 变得更简单</span>
$ curl localhost:8080/apis/apps/v1/deployments
<span class=o>{</span>
  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;DeploymentList&#34;</span>,
  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;apps/v1&#34;</span>,
  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;resourceVersion&#34;</span>: <span class=s2>&#34;660883&#34;</span>
  <span class=o>}</span>,
  <span class=s2>&#34;items&#34;</span>: <span class=o>[</span>...<span class=o>]</span>
<span class=o>}</span>
</code></pre></div><h3 id=kubectl-使用原始模式调用-api>kubectl 使用原始模式调用 API<a hidden class=anchor aria-hidden=true href=#kubectl-使用原始模式调用-api>#</a></h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 获取</span>
$ kubectl get --raw /api/v1/namespaces/default/pods

<span class=c1># 创建</span>
$ kubectl create --raw /api/v1/namespaces/default/pods -f file.yaml

<span class=c1># 更新</span>
$ kubectl replace --raw /api/v1/namespaces/default/pods/mypod -f file.json

<span class=c1># 删除</span>
$ kubectl delete --raw /api/v1/namespaces/default/pods
</code></pre></div><h2 id=如何查看-kubectl-命令如-apply发送的-api-请求>如何查看 kubectl 命令（如 apply）发送的 API 请求<a hidden class=anchor aria-hidden=true href=#如何查看-kubectl-命令如-apply发送的-api-请求>#</a></h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl create deployment nginx --image nginx -v <span class=m>6</span>
I0215 17:07:35.188480   <span class=m>43870</span> loader.go:372<span class=o>]</span> Config loaded from file:  /Users/dp/.kube/config
I0215 17:07:35.362580   <span class=m>43870</span> round_trippers.go:553<span class=o>]</span> POST https://192.168.58.2:8443/apis/apps/v1/namespaces/default/deployments?fieldManager<span class=o>=</span>kubectl-create<span class=p>&amp;</span><span class=nv>fieldValidation</span><span class=o>=</span>Strict <span class=m>201</span> Created in <span class=m>167</span> milliseconds
deployment.apps/nginx created
</code></pre></div><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2>
<ul>
<li><a href=https://iximiuz.com/en/posts/kubernetes-api-call-simple-http-client/>How To Call Kubernetes API using Simple HTTP Client</a></li>
<li><a href=https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/access-cluster-api/>使用 Kubernetes API 访问集群 | Kubernetes</a></li>
<li><a href=https://kubernetes.io/zh-cn/docs/tasks/run-application/access-api-from-pod/>从 Pod 中访问 Kubernetes API | Kuberentes</a></li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
</ul>
<nav class=paginav>
<a class=prev href=https://blog.poneding.com/series/programming-kubernetes/client-gen-usage/>
<strong class=title><i class="fi fi-backward"></i>&nbsp;上一页</strong>
<br>使用 client-gen 生成 clientset 代码</a>
<a class=next href=https://blog.poneding.com/series/programming-kubernetes/how-to-update-kubernetes-resource-object-with-patch-strategy/>
<strong class=title>下一页&nbsp;<i class="fi fi-forward"></i></strong>
<br>使用 Patch 策略更新 Kubernetes 资源对象</a>
</nav>
</footer>
<div class=giscus_comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOJWLK5A data-category=General data-category-id=DIC_kwDOJWLK5M4CVvA5 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN crossorigin=anonymous async></script>
</div>
<script>document.querySelector("div.giscus_comments > script").setAttribute("data-theme",localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme"):window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.querySelector("#theme-toggle").addEventListener("click",()=>{let a=document.querySelector("iframe.giscus-frame");a&&a.contentWindow.postMessage({giscus:{setConfig:{theme:localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme")==="dark"?"light":"dark":document.body.className.includes("dark")?"light":"dark"}}},"https://giscus.app")})</script>
</div>
<div class=post-right-toc><div class=toc>
<div open>
<div class=inner><ul>
<li>
<a href=#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96-kubernetes-api-server-%e5%9c%b0%e5%9d%80 aria-label="如何获取 Kubernetes api-server 地址">如何获取 Kubernetes api-server 地址</a></li>
<li>
<a href=#api-server-%e5%a6%82%e4%bd%95%e7%bb%99%e5%ae%a2%e6%88%b7%e7%ab%af%e6%8e%88%e6%9d%83 aria-label="api-server 如何给客户端授权">api-server 如何给客户端授权</a><ul>
<li>
<a href=#%e4%bd%bf%e7%94%a8%e8%af%81%e4%b9%a6%e6%8e%88%e6%9d%83 aria-label=使用证书授权>使用证书授权</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-token-%e6%8e%88%e6%9d%83 aria-label="使用 token 授权">使用 token 授权</a></li></ul>
</li>
<li>
<a href=#%e5%9c%a8-pod-%e5%86%85%e8%ae%bf%e9%97%ae-api-server aria-label="在 Pod 内访问 api-server">在 Pod 内访问 api-server</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-curl-%e6%89%a7%e8%a1%8c%e5%9f%ba%e6%9c%ac%e7%9a%84-crud-%e6%93%8d%e4%bd%9c aria-label="使用 curl 执行基本的 CRUD 操作">使用 curl 执行基本的 CRUD 操作</a></li>
<li>
<a href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8-kubectl-%e8%b0%83%e7%94%a8-api aria-label="如何使用 kubectl 调用 API">如何使用 kubectl 调用 API</a><ul>
<li>
<a href=#%e4%bd%bf%e7%94%a8-kubectl-%e4%bb%a3%e7%90%86-kubernetes-api-server aria-label="使用 kubectl 代理 Kubernetes api-server">使用 kubectl 代理 Kubernetes api-server</a></li>
<li>
<a href=#kubectl-%e4%bd%bf%e7%94%a8%e5%8e%9f%e5%a7%8b%e6%a8%a1%e5%bc%8f%e8%b0%83%e7%94%a8-api aria-label="kubectl 使用原始模式调用 API">kubectl 使用原始模式调用 API</a></li></ul>
</li>
<li>
<a href=#%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b-kubectl-%e5%91%bd%e4%bb%a4%e5%a6%82-apply%e5%8f%91%e9%80%81%e7%9a%84-api-%e8%af%b7%e6%b1%82 aria-label="如何查看 kubectl 命令（如 apply）发送的 API 请求">如何查看 kubectl 命令（如 apply）发送的 API 请求</a></li>
<li>
<a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a>
</li>
</ul>
</div>
</div>
</div>
<script>let activeElement,elements;window.addEventListener('DOMContentLoaded',function(b){elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]'),activeElement=elements[0];const a=encodeURI(activeElement.getAttribute('id')).toLowerCase();document.querySelector(`.inner ul li a[href="#${a}"]`).classList.add('active')},!1),window.addEventListener('scroll',()=>{activeElement=Array.from(elements).find(a=>{if(getOffsetTop(a)-window.pageYOffset>0&&getOffsetTop(a)-window.pageYOffset<window.innerHeight/2)return a})||activeElement,elements.forEach(a=>{const b=encodeURI(a.getAttribute('id')).toLowerCase();a===activeElement?document.querySelector(`.inner ul li a[href="#${b}"]`)?.classList.add('active'):document.querySelector(`.inner ul li a[href="#${b}"]`)?.classList.remove('active')})},!1);function getOffsetTop(a){if(!a.getClientRects().length)return 0;let b=a.getBoundingClientRect(),c=a.ownerDocument.defaultView;return b.top+c.pageYOffset}</script>
</div>
<div class=clear_float></div>
</article>
</main>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<footer class=footer>
<p>
<span>
<i class="fi fi-copyright"></i>2024
<a href=https://blog.poneding.com/>博客 · 丁鹏</a>
</span>
&nbsp;|&nbsp;
<span>
<i class="fi fi-fire"></i>本站共计
<a id=busuanzi_value_site_pv>0</a> 次访问 & <a id=busuanzi_value_site_uv>0</a> 位访客
</span>
</p>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='<i class="fi fi-copy"></i>';function d(){a.innerHTML='<i class="fi fi-check"></i>',setTimeout(()=>{a.innerHTML='<i class="fi fi-copy"></i>'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body>
</html>