<!doctype html><html lang=zh dir=auto>
<head>
<link rel=stylesheet href=/css/fi.css crossorigin=anonymous><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>如何写一个 Admission Webhook | 博客 · 丁鹏</title>
<meta name=keywords content="Kubernetes,Admission Webhook">
<meta name=description content="准入控制器（Admission Controllers） Admission Controllers 是 Kubernets API Server 中的一种插件机制，它可以在 API 资源对象创建、更新、删除的请求通过认证和鉴权之">
<meta name=author content="Pone Ding">
<link rel=canonical href=https://blog.poneding.com/series/programming-kubernetes/how-to-write-an-admission-webhook/>
<meta name=baidu-site-verification content="codeva-TIM45BA2zX">
<meta name=google-site-verification content="gigju1hgWV5auIGFQ92BEHHWLdQlDKD9Vtr0i0nJTdc">
<meta name=msvalidate.01 content="A6DA701A68DFFC170A595897CB4DF119">
<link crossorigin=anonymous href=/assets/css/stylesheet.65f6d323040845323012b2b152ef69268b9604fa8bfd2586c65c94d786ed4850.css integrity="sha256-ZfbTIwQIRTIwErKxUu9pJouWBPqL/SWGxlyU14btSFA=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.poneding.com/images/blog.png>
<link rel=icon type=image/png sizes=16x16 href=https://blog.poneding.com/images/blog.png>
<link rel=icon type=image/png sizes=32x32 href=https://blog.poneding.com/images/blog.png>
<link rel=apple-touch-icon href=https://blog.poneding.com/images/blog.png>
<link rel=mask-icon href=https://blog.poneding.com/images/blog.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="如何写一个 Admission Webhook">
<meta property="og:description" content="准入控制器（Admission Controllers） Admission Controllers 是 Kubernets API Server 中的一种插件机制，它可以在 API 资源对象创建、更新、删除的请求通过认证和鉴权之">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.poneding.com/series/programming-kubernetes/how-to-write-an-admission-webhook/">
<meta property="og:image" content="https://fs.poneding.com/images/202305041519080.png"><meta property="article:section" content="series">
<meta property="article:published_time" content="2023-04-26T07:40:56+00:00">
<meta property="article:modified_time" content="2023-04-26T07:40:56+00:00"><meta property="og:site_name" content="博客">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://fs.poneding.com/images/202305041519080.png">
<meta name=twitter:title content="如何写一个 Admission Webhook">
<meta name=twitter:description content="准入控制器（Admission Controllers） Admission Controllers 是 Kubernets API Server 中的一种插件机制，它可以在 API 资源对象创建、更新、删除的请求通过认证和鉴权之">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"系列","item":"https://blog.poneding.com/series/"},{"@type":"ListItem","position":2,"name":"Kubernetes 编程","item":"https://blog.poneding.com/series/programming-kubernetes/"},{"@type":"ListItem","position":3,"name":"如何写一个 Admission Webhook","item":"https://blog.poneding.com/series/programming-kubernetes/how-to-write-an-admission-webhook/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何写一个 Admission Webhook","name":"如何写一个 Admission Webhook","description":"准入控制器（Admission Controllers） Admission Controllers 是 Kubernets API Server 中的一种插件机制，它可以在 API 资源对象创建、更新、删除的请求通过认证和鉴权之","keywords":["Kubernetes","Admission Webhook"],"articleBody":"准入控制器（Admission Controllers） Admission Controllers 是 Kubernets API Server 中的一种插件机制，它可以在 API 资源对象创建、更新、删除的请求通过认证和鉴权之后，持久化到 etcd 之前，对资源对象进行额外的变更（Mutating）或者校验（Validating），准入控制器不会拦截对资源的读请求（Get，Watch，List）。\n准入控制分为两个阶段：第一阶段，运行变更准入控制器；第二阶段，运行验证准入控制器。变更准入控制器可以变更资源，也可以对请求进行验证；但是验证准入控制器只能对请求进行验证，不能变更资源。\n准入 Webhook（Admission Webhook）  \nAdmission Webhook 是准入控制器的一种实现方式，它是一个 HTTP Server，它监听一个端口，等待 API Server 的准入请求，请求体是一个 AdmissionReview 对象，它包含了 AdmissionRequest 和 AdmissionResponse，AdmissionRequest 里面包含了请求的资源对象信息，AdmissionResponse 里面包含了准入控制器对请求的处理结果。\n \n上图展示了 APIServer 在接收到请求之后，所有的处理流程。我们集中关注 Admission 部分，在这部分里面，首先会调用 Admission Mutating Webhook，然后调用 Admission Validating Webhook。\n写一个 Admission 控制器 我们以 MutatingAdmissionWebhook 为例，来写一个 Admission 控制器。\n查看源码\nAdmission Webhook Server 是一个 HTTP Server，它需要监听一个端口，等待 API Server 发送 AdmissionRequest 请求，然后对 AdmissionRequest 进行处理，最后返回 AdmissionResponse。\n先来看一下 AdmissionReview 的结构：\ntype AdmissionReview struct { metav1.TypeMeta `json:\",inline\"` Request *AdmissionRequest `json:\"request,omitempty\" protobuf:\"bytes,1,opt,name=request\"` Response *AdmissionResponse `json:\"response,omitempty\" protobuf:\"bytes,2,opt,name=response\"` } AdmissionReview 里面包含了 AdmissionRequest 和 AdmissionResponse，我们先来看一下 AdmissionRequest 的结构：\ntype AdmissionRequest struct { UID types.UID `json:\"uid\" protobuf:\"bytes,1,opt,name=uid\"` Kind metav1.GroupVersionKind `json:\"kind\" protobuf:\"bytes,2,opt,name=kind\"` Resource metav1.GroupVersionResource `json:\"resource\" protobuf:\"bytes,3,opt,name=resource\"` SubResource string `json:\"subResource,omitempty\" protobuf:\"bytes,4,opt,name=subResource\"` RequestKind *metav1.GroupVersionKind `json:\"requestKind,omitempty\" protobuf:\"bytes,13,opt,name=requestKind\"` RequestResource *metav1.GroupVersionResource `json:\"requestResource,omitempty\" protobuf:\"bytes,14,opt,name=requestResource\"` RequestSubResource string `json:\"requestSubResource,omitempty\" protobuf:\"bytes,15,opt,name=requestSubResource\"` Name string `json:\"name,omitempty\" protobuf:\"bytes,5,opt,name=name\"` Namespace string `json:\"namespace,omitempty\" protobuf:\"bytes,6,opt,name=namespace\"` Operation Operation `json:\"operation\" protobuf:\"bytes,7,opt,name=operation\"` UserInfo authenticationv1.UserInfo `json:\"userInfo\" protobuf:\"bytes,8,opt,name=userInfo\"` Object runtime.RawExtension `json:\"object,omitempty\" protobuf:\"bytes,9,opt,name=object\"` OldObject runtime.RawExtension `json:\"oldObject,omitempty\" protobuf:\"bytes,10,opt,name=oldObject\"` DryRun *bool `json:\"dryRun,omitempty\" protobuf:\"varint,11,opt,name=dryRun\"` Options runtime.RawExtension `json:\"options,omitempty\" protobuf:\"bytes,12,opt,name=options\"` } 场景 某项目团队，为了提高镜像访问速度，决定将镜像仓库从 Docker Hub 迁移到阿里云镜像仓库。但是，由于项目中有很多 Pod 使用了 Docker Hub 的镜像，如果手动修改，工作量太大，所以决定写一个 Admission 控制器，将 Pod 中的镜像仓库地址修改为阿里云镜像仓库。\n1. 编写 Admission Webhook 首先，我们需要引入需要的包\npackage main import ( \"encoding/json\" \"fmt\" \"log\" \"net/http\" \"os\" \"strings\" v1 \"k8s.io/api/admission/v1\" corev1 \"k8s.io/api/core/v1\" metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/klog/v2\" ) 由于 Admission Webhook Server 需要使用 HTTPS，所以我们需要事先准备好证书和私钥，这里我们使用了 cert-manager 生成的证书和私钥。\n安装 cert-manager，参考官方文档：https://cert-manager.io/docs/installation/\nkubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.yaml 创建证书和私钥，以下是示例： webhook-cert.yaml\napiVersion:cert-manager.io/v1kind:Certificatemetadata:name:example-webhook-certspec:secretName:example-admission-webhook-cert-secretduration:2160h# 90 daysrenewBefore:360h# 15 dayscommonName:example-admission-webhook.default.svcdnsNames:- default-admission-webhook.default.svcissuerRef:name:default-admission-webhook-issuerkind:ClusterIssuer---apiVersion:cert-manager.io/v1kind:ClusterIssuermetadata:name:default-admission-webhook-issuerspec:selfSigned:{}执行以下命令，创建证书和 Issuer：\nkubectl apply -f webhook-cert.yaml 在 Admission 控制器中，我们需要使用到证书和私钥，所以我们需要将证书和私钥保存到 Secret 中，以下是示例：\n// AdmissionResponse contains the fields extracted from an AdmissionReview response type AdmissionResponse struct { AuditAnnotations map[string]string Allowed bool Patch []byte PatchType admissionv1.PatchType Result *metav1.Status Warnings []string } 注册 Admission 控制器 将 Admission 控制器注册到 API Server，需要创建一个 MutatingWebhookConfiguration/ValidatingWebhookConfiguration 对象，然后将该对象提交到 API Server。以下是示例：\napiVersion:admissionregistration.k8s.io/v1kind:MutatingWebhookConfigurationmetadata:name:example-admission-webhookannotations:cert-manager.io/inject-ca-from:default/example-admission-webhook-certwebhooks:- admissionReviewVersions:- v1clientConfig:caBundle:\"\"service:name:example-admission-webhooknamespace:defaultport:443path:/mutatingfailurePolicy:IgnorematchPolicy:Exactname:example-admission-webhook.default.svcrules:- apiGroups:- \"\"apiVersions:- v1operations:- CREATE- UPDATEresources:- podsscope:\"*\"objectSelector:matchExpressions:- key:example-admission-webhook-testoperator:ExistssideEffects:NonetimeoutSeconds:3 ⚠️ 注意：\n1、cert-manager.io/inject-ca-from 注解指定了证书的 Secret，这里使用了 cert-manager 生成的证书和私钥；\n2、clientConfig.service 字段指定了 Admission Webhook Server 的地址，这里使用了本测试 Admission 控制器的 Kubernetes Service 的地址；\n3、为了测试不影响其他 Pod 的正常验证逻辑，objectSelector 字段指定包含了 example-admission-webhook-test 标签的 Pod 才会被本测试 Admission 控制器处理。\n 测试 1. 部署 Admission 控制器 kubectl apply -f deployment.yaml 参考资料  准入控制器参考 | Kubernetes 动态准入控制 | Kubernetes Kubernetes admission webhook server 开发教程  ","wordCount":"1583","inLanguage":"zh","image":"https://fs.poneding.com/images/202305041519080.png","datePublished":"2023-04-26T07:40:56.946Z","dateModified":"2023-04-26T07:40:56.946Z","author":[{"@type":"Person","name":"Pone Ding"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.poneding.com/series/programming-kubernetes/how-to-write-an-admission-webhook/"},"publisher":{"@type":"Organization","name":"博客 · 丁鹏","logo":{"@type":"ImageObject","url":"https://blog.poneding.com/images/blog.png"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blog.poneding.com/ accesskey=h title="博客 (Alt + H)">
<img src=https://blog.poneding.com/images/blog.png alt aria-label=logo height=25>博客</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=https://blog.poneding.com/posts/ title=文章>
<span>
<i class="fi fi-book"></i>&nbsp;文章</span>
</a>
</li>
<li>
<a href=https://blog.poneding.com/series/ title=系列>
<span class=active>
<i class="fi fi-series"></i>&nbsp;系列</span>
</a>
</li>
<li>
<a href=https://blog.poneding.com/tags/ title=标签>
<span>
<i class="fi fi-tags"></i>&nbsp;标签</span>
</a>
</li>
<li>
<a href=https://blog.poneding.com/archives/ title=归档>
<span>
<i class="fi fi-folder"></i>&nbsp;归档</span>
</a>
</li>
<li>
<a href=/search title="Alt + /" accesskey=/>
<span>
<i class="fi fi-search"></i>
</span>
</a>
</li>
<li>
<span>|</span>
</li>
<li>
<span>
<a href=https://github.com/poneding target=_blank rel="noopener noreferrer me">
<i class="fi fi-github"></i>
</a>
<span>·</span>
<a href=mailto:poneding@gmail.com target=_blank rel="noopener noreferrer me">
<i class="fi fi-mail"></i>
</a>
</span>
</li>
</ul>
</nav>
</header><main class=main>
<article class=post-single>
<div class=post-left-article>
<header class=post-header>
<div class=breadcrumbs><p>
<span><a href=/><i class="fi fi-home"></i>&nbsp;主页</a></span><span><i class="fi fi-angle-right"></i><a href=https://blog.poneding.com/series/>系列</a></span><span><i class="fi fi-angle-right"></i><a href=https://blog.poneding.com/series/programming-kubernetes/>Kubernetes 编程</a></span><i class="fi fi-angle-right"></i><span>如何写一个 Admission Webhook</span>
</p>
</div>
<h1 id=post-title class=post-title>
如何写一个 Admission Webhook
</h1>
<div class=post-meta><span class=meta-item>
<span>
<i class="fi fi-clock"></i>2023-04-26
</span>
</span><span class=meta-item>
<span>
&nbsp;·&nbsp;<i class="fi fi-word"></i>1583 字</span>
</span><span class=meta-item>
&nbsp;·&nbsp;<i class="fi fi-eye"></i>&nbsp;<span id=busuanzi_value_page_pv></span>
</span>&nbsp;|&nbsp;<a href=https://github.com/poneding/blog/edit/master/content/series/programming-kubernetes/%e5%a6%82%e4%bd%95%e5%86%99%e4%b8%80%e4%b8%aa-admission-webhook.md rel="noopener noreferrer" target=_blank>
<i class="fi fi-edit"></i>&nbsp;编辑</a>
</div>
</header>
<figure class=post-single-cover><input type=checkbox id=zoomCheck-cover3 hidden>
<label for=zoomCheck-cover3><img class=zoomCheck loading=lazy src=https://fs.poneding.com/images/202305041519080.png alt></label>
</figure>
<div class=post-content><h2 id=准入控制器admission-controllers>准入控制器（Admission Controllers）<a hidden class=anchor aria-hidden=true href=#准入控制器admission-controllers>#</a></h2>
<p>Admission Controllers 是 Kubernets API Server 中的一种插件机制，它可以在 API 资源对象创建、更新、删除的请求通过认证和鉴权之后，持久化到 etcd 之前，对资源对象进行额外的变更（Mutating）或者校验（Validating），准入控制器不会拦截对资源的读请求（Get，Watch，List）。</p>
<p>准入控制分为两个阶段：第一阶段，运行变更准入控制器；第二阶段，运行验证准入控制器。变更准入控制器可以变更资源，也可以对请求进行验证；但是验证准入控制器只能对请求进行验证，不能变更资源。</p>
<h2 id=准入-webhookadmission-webhook>准入 Webhook（Admission Webhook）<a hidden class=anchor aria-hidden=true href=#准入-webhookadmission-webhook>#</a></h2>
<p>
<input type=checkbox id=zoomCheck-7a607 hidden>
<label for=zoomCheck-7a607>
<img class=zoomCheck loading=lazy decoding=async src=https://fs.poneding.com/images/202305041453105.png alt=202305041453105.png>
</label></p>
<p>Admission Webhook 是准入控制器的一种实现方式，它是一个 HTTP Server，它监听一个端口，等待 API Server 的准入请求，请求体是一个 <code>AdmissionReview</code> 对象，它包含了 <code>AdmissionRequest</code> 和 <code>AdmissionResponse</code>，<code>AdmissionRequest</code> 里面包含了请求的资源对象信息，<code>AdmissionResponse</code> 里面包含了准入控制器对请求的处理结果。</p>
<p>
<input type=checkbox id=zoomCheck-7ed61 hidden>
<label for=zoomCheck-7ed61>
<img class=zoomCheck loading=lazy decoding=async src=https://fs.poneding.com/images/202305041439868.png alt=202305041439868.png>
</label></p>
<p>上图展示了 APIServer 在接收到请求之后，所有的处理流程。我们集中关注 Admission 部分，在这部分里面，首先会调用 Admission Mutating Webhook，然后调用 Admission Validating Webhook。</p>
<h2 id=写一个-admission-控制器>写一个 Admission 控制器<a hidden class=anchor aria-hidden=true href=#写一个-admission-控制器>#</a></h2>
<p>我们以 MutatingAdmissionWebhook 为例，来写一个 Admission 控制器。<br>
<a href=https://github.com/poneding/programming-kubernetes/tree/master/examples>查看源码</a></p>
<p>Admission Webhook Server 是一个 HTTP Server，它需要监听一个端口，等待 API Server 发送 AdmissionRequest 请求，然后对 AdmissionRequest 进行处理，最后返回 AdmissionResponse。</p>
<p>先来看一下 AdmissionReview 的结构：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>AdmissionReview</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
	<span class=nx>Request</span>  <span class=o>*</span><span class=nx>AdmissionRequest</span> <span class=s>`json:&#34;request,omitempty&#34; protobuf:&#34;bytes,1,opt,name=request&#34;`</span>
	<span class=nx>Response</span> <span class=o>*</span><span class=nx>AdmissionResponse</span> <span class=s>`json:&#34;response,omitempty&#34; protobuf:&#34;bytes,2,opt,name=response&#34;`</span>
<span class=p>}</span>
</code></pre></div><p><code>AdmissionReview</code> 里面包含了 <code>AdmissionRequest</code> 和 <code>AdmissionResponse</code>，我们先来看一下 <code>AdmissionRequest</code> 的结构：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>AdmissionRequest</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>UID</span> <span class=nx>types</span><span class=p>.</span><span class=nx>UID</span> <span class=s>`json:&#34;uid&#34; protobuf:&#34;bytes,1,opt,name=uid&#34;`</span>
	<span class=nx>Kind</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GroupVersionKind</span> <span class=s>`json:&#34;kind&#34; protobuf:&#34;bytes,2,opt,name=kind&#34;`</span>
	<span class=nx>Resource</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GroupVersionResource</span> <span class=s>`json:&#34;resource&#34; protobuf:&#34;bytes,3,opt,name=resource&#34;`</span>
	<span class=nx>SubResource</span> <span class=kt>string</span> <span class=s>`json:&#34;subResource,omitempty&#34; protobuf:&#34;bytes,4,opt,name=subResource&#34;`</span>

	<span class=nx>RequestKind</span> <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>GroupVersionKind</span> <span class=s>`json:&#34;requestKind,omitempty&#34; protobuf:&#34;bytes,13,opt,name=requestKind&#34;`</span>
	<span class=nx>RequestResource</span> <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>GroupVersionResource</span> <span class=s>`json:&#34;requestResource,omitempty&#34; protobuf:&#34;bytes,14,opt,name=requestResource&#34;`</span>
	<span class=nx>RequestSubResource</span> <span class=kt>string</span> <span class=s>`json:&#34;requestSubResource,omitempty&#34; protobuf:&#34;bytes,15,opt,name=requestSubResource&#34;`</span>

	<span class=nx>Name</span> <span class=kt>string</span> <span class=s>`json:&#34;name,omitempty&#34; protobuf:&#34;bytes,5,opt,name=name&#34;`</span>
	<span class=nx>Namespace</span> <span class=kt>string</span> <span class=s>`json:&#34;namespace,omitempty&#34; protobuf:&#34;bytes,6,opt,name=namespace&#34;`</span>
	<span class=nx>Operation</span> <span class=nx>Operation</span> <span class=s>`json:&#34;operation&#34; protobuf:&#34;bytes,7,opt,name=operation&#34;`</span>
	<span class=nx>UserInfo</span> <span class=nx>authenticationv1</span><span class=p>.</span><span class=nx>UserInfo</span> <span class=s>`json:&#34;userInfo&#34; protobuf:&#34;bytes,8,opt,name=userInfo&#34;`</span>
	<span class=nx>Object</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>RawExtension</span> <span class=s>`json:&#34;object,omitempty&#34; protobuf:&#34;bytes,9,opt,name=object&#34;`</span>
	<span class=nx>OldObject</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>RawExtension</span> <span class=s>`json:&#34;oldObject,omitempty&#34; protobuf:&#34;bytes,10,opt,name=oldObject&#34;`</span>
	<span class=nx>DryRun</span> <span class=o>*</span><span class=kt>bool</span> <span class=s>`json:&#34;dryRun,omitempty&#34; protobuf:&#34;varint,11,opt,name=dryRun&#34;`</span>
	<span class=nx>Options</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>RawExtension</span> <span class=s>`json:&#34;options,omitempty&#34; protobuf:&#34;bytes,12,opt,name=options&#34;`</span>
<span class=p>}</span>
</code></pre></div><h3 id=场景>场景<a hidden class=anchor aria-hidden=true href=#场景>#</a></h3>
<p>某项目团队，为了提高镜像访问速度，决定将镜像仓库从 Docker Hub 迁移到阿里云镜像仓库。但是，由于项目中有很多 Pod 使用了 Docker Hub 的镜像，如果手动修改，工作量太大，所以决定写一个 Admission 控制器，将 Pod 中的镜像仓库地址修改为阿里云镜像仓库。</p>
<h3 id=1-编写-admission-webhook>1. 编写 Admission Webhook<a hidden class=anchor aria-hidden=true href=#1-编写-admission-webhook>#</a></h3>
<p>首先，我们需要引入需要的包</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;encoding/json&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;net/http&#34;</span>
	<span class=s>&#34;os&#34;</span>
	<span class=s>&#34;strings&#34;</span>

	<span class=nx>v1</span> <span class=s>&#34;k8s.io/api/admission/v1&#34;</span>
	<span class=nx>corev1</span> <span class=s>&#34;k8s.io/api/core/v1&#34;</span>
	<span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class=s>&#34;k8s.io/klog/v2&#34;</span>
<span class=p>)</span>
</code></pre></div><p>由于 Admission Webhook Server 需要使用 HTTPS，所以我们需要事先准备好证书和私钥，这里我们使用了 <a href=https://cert-manager.io/>cert-manager</a> 生成的证书和私钥。</p>
<p>安装 cert-manager，参考官方文档：<a href=https://cert-manager.io/docs/installation/>https://cert-manager.io/docs/installation/</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.yaml
</code></pre></div><p>创建证书和私钥，以下是示例：
<em>webhook-cert.yaml</em></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert-manager.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-webhook-cert</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>example-admission-webhook-cert-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>duration</span><span class=p>:</span><span class=w> </span><span class=l>2160h</span><span class=w> </span><span class=c># 90 days</span><span class=w>
</span><span class=w>  </span><span class=nt>renewBefore</span><span class=p>:</span><span class=w> </span><span class=l>360h</span><span class=w> </span><span class=c># 15 days</span><span class=w>
</span><span class=w>  </span><span class=nt>commonName</span><span class=p>:</span><span class=w> </span><span class=l>example-admission-webhook.default.svc</span><span class=w>
</span><span class=w>  </span><span class=nt>dnsNames</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>default-admission-webhook.default.svc</span><span class=w>
</span><span class=w>  </span><span class=nt>issuerRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-admission-webhook-issuer</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIssuer</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert-manager.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIssuer</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-admission-webhook-issuer</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selfSigned</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></code></pre></div><p>执行以下命令，创建证书和 Issuer：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>kubectl apply -f webhook-cert.yaml
</code></pre></div><p>在 Admission 控制器中，我们需要使用到证书和私钥，所以我们需要将证书和私钥保存到 Secret 中，以下是示例：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// AdmissionResponse contains the fields extracted from an AdmissionReview response
</span><span class=c1></span><span class=kd>type</span> <span class=nx>AdmissionResponse</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>AuditAnnotations</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
	<span class=nx>Allowed</span>          <span class=kt>bool</span>
	<span class=nx>Patch</span>            <span class=p>[]</span><span class=kt>byte</span>
	<span class=nx>PatchType</span>        <span class=nx>admissionv1</span><span class=p>.</span><span class=nx>PatchType</span>
	<span class=nx>Result</span>           <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span>
	<span class=nx>Warnings</span>         <span class=p>[]</span><span class=kt>string</span>
<span class=p>}</span>
</code></pre></div><h2 id=注册-admission-控制器>注册 Admission 控制器<a hidden class=anchor aria-hidden=true href=#注册-admission-控制器>#</a></h2>
<p>将 Admission 控制器注册到 API Server，需要创建一个 MutatingWebhookConfiguration/ValidatingWebhookConfiguration 对象，然后将该对象提交到 API Server。以下是示例：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>MutatingWebhookConfiguration</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-admission-webhook</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cert-manager.io/inject-ca-from</span><span class=p>:</span><span class=w> </span><span class=l>default/example-admission-webhook-cert</span><span class=w>
</span><span class=w></span><span class=nt>webhooks</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>admissionReviewVersions</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>v1</span><span class=w>
</span><span class=w>    </span><span class=nt>clientConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>caBundle</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-admission-webhook</span><span class=w>
</span><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/mutating</span><span class=w>
</span><span class=w>    </span><span class=nt>failurePolicy</span><span class=p>:</span><span class=w> </span><span class=l>Ignore</span><span class=w>
</span><span class=w>    </span><span class=nt>matchPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Exact</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-admission-webhook.default.svc</span><span class=w>
</span><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>apiVersions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=l>v1</span><span class=w>
</span><span class=w>        </span><span class=nt>operations</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=l>CREATE</span><span class=w>
</span><span class=w>          </span>- <span class=l>UPDATE</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=l>pods</span><span class=w>
</span><span class=w>        </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>objectSelector</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>example-admission-webhook-test</span><span class=w>
</span><span class=w>          </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Exists</span><span class=w>
</span><span class=w>    </span><span class=nt>sideEffects</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span><span class=w>    </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></code></pre></div><blockquote>
<p>⚠️ 注意：<br>
1、<code>cert-manager.io/inject-ca-from</code> 注解指定了证书的 Secret，这里使用了 cert-manager 生成的证书和私钥；<br>
2、<code>clientConfig.service</code> 字段指定了 Admission Webhook Server 的地址，这里使用了本测试 Admission 控制器的 Kubernetes Service 的地址；<br>
3、为了测试不影响其他 Pod 的正常验证逻辑，<code>objectSelector</code> 字段指定包含了 <code>example-admission-webhook-test</code> 标签的 Pod 才会被本测试 Admission 控制器处理。</p>
</blockquote>
<h2 id=测试>测试<a hidden class=anchor aria-hidden=true href=#测试>#</a></h2>
<h3 id=1-部署-admission-控制器>1. 部署 Admission 控制器<a hidden class=anchor aria-hidden=true href=#1-部署-admission-控制器>#</a></h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>kubectl apply -f deployment.yaml
</code></pre></div><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2>
<ul>
<li><a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/>准入控制器参考 | Kubernetes</a></li>
<li><a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/>动态准入控制 | Kubernetes</a></li>
<li><a href=https://www.zeng.dev/post/2021-denyenv-validating-admission-webhook/>Kubernetes admission webhook server 开发教程</a></li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://blog.poneding.com/tags/kubernetes/><i class="fi fi-tag"></i>&nbsp;Kubernetes</a></li>
<li><a href=https://blog.poneding.com/tags/admission-webhook/><i class="fi fi-tag"></i>&nbsp;Admission Webhook</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://blog.poneding.com/series/programming-kubernetes/how-to-update-kubernetes-resource-object-with-patch-strategy/>
<strong class=title><i class="fi fi-backward"></i>&nbsp;上一页</strong>
<br>使用 Patch 策略更新 Kubernetes 资源对象</a>
<a class=next href=https://blog.poneding.com/posts/acme-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/>
<strong class=title>下一页&nbsp;<i class="fi fi-forward"></i></strong>
<br>ACME 工作原理</a>
</nav>
</footer>
<div class=giscus_comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOJWLK5A data-category=General data-category-id=DIC_kwDOJWLK5M4CVvA5 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN crossorigin=anonymous async></script>
</div>
<script>document.querySelector("div.giscus_comments > script").setAttribute("data-theme",localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme"):window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.querySelector("#theme-toggle").addEventListener("click",()=>{let a=document.querySelector("iframe.giscus-frame");a&&a.contentWindow.postMessage({giscus:{setConfig:{theme:localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme")==="dark"?"light":"dark":document.body.className.includes("dark")?"light":"dark"}}},"https://giscus.app")})</script>
</div>
<div class=post-right-toc><div class=toc>
<div open>
<div class=inner><ul>
<li>
<a href=#%e5%87%86%e5%85%a5%e6%8e%a7%e5%88%b6%e5%99%a8admission-controllers aria-label="准入控制器（Admission Controllers）">准入控制器（Admission Controllers）</a></li>
<li>
<a href=#%e5%87%86%e5%85%a5-webhookadmission-webhook aria-label="准入 Webhook（Admission Webhook）">准入 Webhook（Admission Webhook）</a></li>
<li>
<a href=#%e5%86%99%e4%b8%80%e4%b8%aa-admission-%e6%8e%a7%e5%88%b6%e5%99%a8 aria-label="写一个 Admission 控制器">写一个 Admission 控制器</a><ul>
<li>
<a href=#%e5%9c%ba%e6%99%af aria-label=场景>场景</a></li>
<li>
<a href=#1-%e7%bc%96%e5%86%99-admission-webhook aria-label="1. 编写 Admission Webhook">1. 编写 Admission Webhook</a></li></ul>
</li>
<li>
<a href=#%e6%b3%a8%e5%86%8c-admission-%e6%8e%a7%e5%88%b6%e5%99%a8 aria-label="注册 Admission 控制器">注册 Admission 控制器</a></li>
<li>
<a href=#%e6%b5%8b%e8%af%95 aria-label=测试>测试</a><ul>
<li>
<a href=#1-%e9%83%a8%e7%bd%b2-admission-%e6%8e%a7%e5%88%b6%e5%99%a8 aria-label="1. 部署 Admission 控制器">1. 部署 Admission 控制器</a></li></ul>
</li>
<li>
<a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a>
</li>
</ul>
</div>
</div>
</div>
<script>let activeElement,elements;window.addEventListener('DOMContentLoaded',function(b){elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]'),activeElement=elements[0];const a=encodeURI(activeElement.getAttribute('id')).toLowerCase();document.querySelector(`.inner ul li a[href="#${a}"]`).classList.add('active')},!1),window.addEventListener('scroll',()=>{activeElement=Array.from(elements).find(a=>{if(getOffsetTop(a)-window.pageYOffset>0&&getOffsetTop(a)-window.pageYOffset<window.innerHeight/2)return a})||activeElement,elements.forEach(a=>{const b=encodeURI(a.getAttribute('id')).toLowerCase();a===activeElement?document.querySelector(`.inner ul li a[href="#${b}"]`)?.classList.add('active'):document.querySelector(`.inner ul li a[href="#${b}"]`)?.classList.remove('active')})},!1);function getOffsetTop(a){if(!a.getClientRects().length)return 0;let b=a.getBoundingClientRect(),c=a.ownerDocument.defaultView;return b.top+c.pageYOffset}</script>
</div>
<div class=clear_float></div>
</article>
</main>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<footer class=footer>
<p>
<span>
<i class="fi fi-copyright"></i>2024
<a href=https://blog.poneding.com/>博客 · 丁鹏</a>
</span>
&nbsp;|&nbsp;
<span>
<i class="fi fi-fire"></i>本站共计
<a id=busuanzi_value_site_pv>0</a> 次访问 & <a id=busuanzi_value_site_uv>0</a> 位访客
</span>
</p>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='<i class="fi fi-copy"></i>';function d(){a.innerHTML='<i class="fi fi-check"></i>',setTimeout(()=>{a.innerHTML='<i class="fi fi-copy"></i>'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body>
</html>